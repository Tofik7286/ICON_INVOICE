{% extends "invoices/base.html" %}
{% load number_words %}

{% block title %}Preview Invoice{% endblock %}

{% block content %}
<div class="card p-4">
  <h3 class="mb-4">üîç Preview Invoice {{ invoice.invoice_number }}</h3>

  <!-- Parties Info -->
  <div class="row">
    <div class="col-md-6 mb-3">
      <h5>From:</h5>
      <p>
        <strong>{{ invoice.from_party.name }}</strong><br>
        {{ invoice.from_party.address_line1 }}<br>
        {{ invoice.from_party.city }} - {{ invoice.from_party.pincode }}<br>
        GST: {{ invoice.from_party.gstin }}
      </p>
    </div>
    <div class="col-md-6 mb-3">
      <h5>To:</h5>
      <p>
        <strong>{{ invoice.to_party.name }}</strong><br>
        {{ invoice.to_party.address_line1 }}<br>
        {{ invoice.to_party.city }} - {{ invoice.to_party.pincode }}<br>
        GST: {{ invoice.to_party.gstin }}
      </p>
    </div>
  </div>

  <!-- Items Table -->
  <div class="table-responsive">
    <table class="table table-bordered text-center mt-3">
      <thead class="table-light">
  <tr>
    <th>#</th>
    <th>Description</th>
    <th>HSN/SAC</th>
    <th>Qty</th>
    <th>Unit</th>
    <th>Rate</th>
    <th>Discount %</th>
    <th>GST %</th>
    <th>Amount</th>
  </tr>
</thead>
<tbody>
  {% for item in invoice.items.all %}
    <tr>
      <td>{{ forloop.counter }}</td>
      <td>
        {% if item.product and item.description %}
          {{ item.product.name }} ‚Äî {{ item.description }}
        {% elif item.product %}
          {{ item.product.name }}
        {% elif item.description %}
          {{ item.description }}
        {% else %}
          ‚Äî
        {% endif %}
      </td>
      <td>{{ item.hsn_sac }}</td>
      <td>{{ item.quantity }}</td>
      <td>{{ item.unit.label }}</td>
      <td>{{ item.effective_rate }}</td>

      <!-- Discount -->
      <td>
        {% if item.discount_percent|floatformat != '0.00' %}
          {{ item.discount_percent }}%
        {% else %}
          ‚Äî
        {% endif %}
      </td>

      <!-- GST -->
        <td class="center">
          {% if item.gst_percent %}
            {{ item.gst_percent }}%
          {% else %}
            ‚Äî
          {% endif %}
        </td>
        <td class="right">{{ item.gst_amount }}</td>


      <td>{{ item.line_taxable_amount }}</td>
    </tr>
  {% empty %}
    <tr><td colspan="9" class="text-muted">No items found.</td></tr>
  {% endfor %}
</tbody>

    </table>
  </div>

  <!-- Totals -->
  <div class="text-end mt-3">
    <p>Subtotal: <strong>{{ invoice.taxable_subtotal }}</strong></p>
    {% if invoice.overall_discount_percent and invoice.overall_discount_percent|floatformat != '0.00' %}
      <p>Discount: <strong>-{{ invoice.total_discount_amount }}</strong></p>
    {% endif %}
    {% if invoice.apply_gst %}
      {% if invoice.is_igst %}
        <p>IGST ({{ invoice.tax.rate_percent }}%): <strong>{{ invoice.tax_amounts.igst }}</strong></p>
      {% else %}
        <p>CGST ({{ invoice.tax.rate_percent|floatformat:0|divisibleby:2 }}%): <strong>{{ invoice.tax_amounts.cgst }}</strong></p>
        <p>SGST ({{ invoice.tax.rate_percent|floatformat:0|divisibleby:2 }}%): <strong>{{ invoice.tax_amounts.sgst }}</strong></p>
      {% endif %}
    {% endif %}
    <h4 class="mt-3">Grand Total: ‚Çπ{{ invoice.grand_total }}</h4>
  </div>

  <!-- Actions -->
  <div class="mt-4 d-flex flex-wrap justify-content-end gap-2">
    <a href="{% url 'invoices:generate_pdf' invoice.pk %}" class="btn btn-success">üìÑ Generate PDF</a>
    <a href="{% url 'invoices:list' %}" class="btn btn-secondary">‚¨Ö Back</a>
  </div>
</div>

<!-- Print Styles -->
<style>
  @media print {
    .btn, nav, footer { display: none !important; }
    .card { border: none; box-shadow: none; }
    body { background: white !important; }
  }
</style>
{% endblock %}
