{% extends "invoices/base.html" %}
{% load static %}
{% block title %}Edit Invoice{% endblock %}

{% block content %}
<style>
  input[readonly] {
    background-color: #f8f9fa;
    cursor: not-allowed;
    font-weight: bold;
  }
</style>

<div class="card p-4">
  <h3 class="mb-4">ðŸ§¾ Edit Invoice #{{ invoice.invoice_number }}</h3>
  <form method="post" id="invoice-form" action="{% url 'invoices:update' invoice.pk %}">
    {% csrf_token %}
    {{ formset.management_form }}

    {# Show form errors #}
    {% if form.non_field_errors %}
      <div class="alert alert-danger">{{ form.non_field_errors }}</div>
    {% endif %}
    {% for field in form %}
      {% for error in field.errors %}
        <div class="alert alert-danger">{{ field.label }}: {{ error }}</div>
      {% endfor %}
    {% endfor %}
    {% if formset.non_form_errors %}
      <div class="alert alert-danger">{{ formset.non_form_errors }}</div>
    {% endif %}
    {% for f in formset.forms %}
      {% for error in f.non_field_errors %}
        <div class="alert alert-danger">Item: {{ error }}</div>
      {% endfor %}
      {% for field in f %}
        {% for error in field.errors %}
          <div class="alert alert-danger">Item {{ forloop.parentloop.counter }} - {{ field.label }}: {{ error }}</div>
        {% endfor %}
      {% endfor %}
    {% endfor %}

    <div class="row mb-3">
      <div class="col-md-3">
        <label class="form-label">Date</label>
        {{ form.date }}
      </div>
      <div class="col-md-4">
        <label class="form-label">From Party</label>
        {{ form.from_party }}
      </div>
      <div class="col-md-4">
        <label class="form-label">To Party</label>
        {{ form.to_party }}
      </div>
    </div>

    <div class="row mb-3">
      <div class="col-md-3">
        <label class="form-label">Overall Discount (%)</label>
        {{ form.overall_discount_percent }}
      </div>
      <div class="col-md-3">
        {{ form.apply_gst }} <label class="form-check-label ms-2">Apply GST?</label>
      </div>
      <div class="col-md-3" id="tax-slab-field">
        <label class="form-label">Tax Slab</label>
        {{ form.tax }}
      </div>
    </div>

    <hr>
    <h5>ðŸ“¦ Items</h5>

    <div class="d-none d-md-block">
      <table class="table table-bordered align-middle text-center">
        <thead class="table-light">
          <tr>
            <th>Product</th>
            <th>HSN/SAC</th>
            <th>Qty</th>
            <th>Unit</th>
            <th>Rate</th>
            <th>Discount %</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="item-rows-desktop">
          {% for form in formset.forms %}
          <tr>
            {{ form.id }}
            <td>{{ form.product }}</td>
            <td>{{ form.hsn_sac }}</td>
            <td>{{ form.quantity }}</td>
            <td>{{ form.unit }}</td>
            <td>{{ form.custom_rate }}</td>
            <td>{{ form.discount_percent }}</td>
            <td>
              <span style="display:none;">{{ form.DELETE }}</span>
              <button type="button" class="btn btn-sm btn-outline-danger delete-row">ðŸ—‘</button>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="d-md-none" id="item-rows-mobile">
      {% for form in formset.forms %}
      <div class="border rounded p-3 mb-3 item-card">
        {{ form.id }}
        <div class="mb-2">
          <label class="form-label">Product</label>
          {{ form.product }}
        </div>
        <div class="mb-2">
          <label class="form-label">HSN/SAC</label>
          {{ form.hsn_sac }}
        </div>
        <div class="row g-2">
          <div class="col-6">
            <label class="form-label">Qty</label>
            {{ form.quantity }}
          </div>
          <div class="col-6">
            <label class="form-label">Unit</label>
            {{ form.unit }}
          </div>
        </div>
        <div class="row g-2 mt-2">
          <div class="col-6">
            <label class="form-label">Rate</label>
            {{ form.custom_rate }}
          </div>
          <div class="col-6">
            <label class="form-label">Discount %</label>
            {{ form.discount_percent }}
          </div>
        </div>
        <div class="text-end mt-2">
          <span style="display:none;">{{ form.DELETE }}</span>
          <button type="button" class="btn btn-sm btn-outline-danger delete-row">ðŸ—‘ Remove</button>
        </div>
      </div>
      {% endfor %}
    </div>

    <div style="display:none;">
      <table>
        <tbody>
          <tr id="empty-form-row-desktop">
            <td>{{ formset.empty_form.product }}</td>
            <td>{{ formset.empty_form.hsn_sac }}</td>
            <td>{{ formset.empty_form.quantity }}</td>
            <td>{{ formset.empty_form.unit }}</td>
            <td>{{ formset.empty_form.custom_rate }}</td>
            <td>{{ formset.empty_form.discount_percent }}</td>
            <td>
              <span style="display:none;">{{ formset.empty_form.DELETE }}</span>
              <button type="button" class="btn btn-sm btn-outline-danger delete-row">ðŸ—‘</button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <div style="display:none;">
      <div id="empty-form-row-mobile" class="border rounded p-3 mb-3 item-card">
        <div class="mb-2">
          <label class="form-label">Product</label>
          {{ formset.empty_form.product }}
        </div>
        <div class="mb-2">
          <label class="form-label">HSN/SAC</label>
          {{ formset.empty_form.hsn_sac }}
        </div>
        <div class="row g-2">
          <div class="col-6">
            <label class="form-label">Qty</label>
            {{ formset.empty_form.quantity }}
          </div>
          <div class="col-6">
            <label class="form-label">Unit</label>
            {{ formset.empty_form.unit }}
          </div>
        </div>
        <div class="row g-2 mt-2">
          <div class="col-6">
            <label class="form-label">Rate</label>
            {{ formset.empty_form.custom_rate }}
          </div>
          <div class="col-6">
            <label class="form-label">Discount %</label>
            {{ formset.empty_form.discount_percent }}
          </div>
        </div>
        <div class="text-end mt-2">
          <span style="display:none;">{{ formset.empty_form.DELETE }}</span>
          <button type="button" class="btn btn-sm btn-outline-danger delete-row">ðŸ—‘ Remove</button>
        </div>
      </div>
    </div>

    <div class="d-flex flex-wrap gap-2 mb-3">
      <button type="button" id="add-item" class="btn btn-outline-primary">âž• Add Item</button>
      <button type="submit" class="btn btn-primary">ðŸ’¾ Save Changes</button>
      <a href="{% url 'invoices:preview' invoice.pk %}" class="btn btn-secondary">Cancel</a>
    </div>

    {{ products|json_script:"product-data" }}
  </form>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
  // ... (JavaScript code waisa hi rahega, usmein koi change nahi)
  (function(){
    const totalFormsInput = document.querySelector('input[name$="-TOTAL_FORMS"]');
    if(!totalFormsInput) return;

    const desktopBody = document.getElementById('item-rows-desktop');
    const mobileBody = document.getElementById('item-rows-mobile');
    const desktopProto = document.getElementById('empty-form-row-desktop');
    const mobileProto = document.getElementById('empty-form-row-mobile');

    // Add Item
    document.getElementById('add-item').addEventListener('click', function(){
      const currentIndex = parseInt(totalFormsInput.value, 10);

      if(window.innerWidth >= 768) {
        let tr = document.createElement('tr');
        tr.innerHTML = desktopProto.innerHTML.replace(/items-__prefix__/g, "items-" + currentIndex);
        desktopBody.appendChild(tr);
      } else {
        let div = document.createElement('div');
        div.className = "border rounded p-3 mb-3 item-card";
        div.innerHTML = mobileProto.innerHTML.replace(/items-__prefix__/g, "items-" + currentIndex);
        mobileBody.appendChild(div);
      }

      totalFormsInput.value = currentIndex + 1;
    });

    // Delete Item
    document.addEventListener('click', function(e){
      if(e.target.closest(".delete-row")){
        const wrapper = e.target.closest("tr, .item-card");
        if(wrapper){
          const deleteInput = wrapper.querySelector("input[type='checkbox'][name$='-DELETE']");
          if(deleteInput){
            deleteInput.checked = true;
            wrapper.style.display = "none";
          } else {
            wrapper.remove();
          }
        }
      }
    });

    // Remove hidden formset before submit to avoid duplicate POST data
    document.getElementById('invoice-form').addEventListener('submit', function(e){
      if(window.innerWidth >= 768) {
        const mobile = document.getElementById('item-rows-mobile');
        if(mobile) mobile.parentNode.removeChild(mobile);
      } else {
        const desktop = document.getElementById('item-rows-desktop');
        if(desktop) desktop.parentNode.removeChild(desktop);
      }
    });
  })();

  // Auto-fill HSN + Rate + Unit
  document.addEventListener('change', function(e) {
    if (e.target.matches("select[name$='-product']")) {
      const container = e.target.closest("tr, .item-card");
      const productId = e.target.value;
      const product = JSON.parse(document.getElementById('product-data').textContent).find(p => p.id == productId);
      if (product && container) {
        const hsn = container.querySelector("input[name$='-hsn_sac']");
        const rate = container.querySelector("input[name$='-custom_rate']");
        const unit = container.querySelector("select[name$='-unit']");
        if (hsn) hsn.value = product.hsn_sac || '';
        if (rate) rate.value = product.rate || '';
        if (unit && product.default_unit_id) {
          unit.value = product.default_unit_id;
          const opt = unit.querySelector(`option[value="${product.default_unit_id}"]`);
          if (opt) opt.selected = true;
        }
      }
    }
  });

  // GST toggle
  function toggleTaxSlab() {
    const applyGST = document.getElementById("id_apply_gst");
    const taxSlabField = document.getElementById("tax-slab-field");
    if (applyGST && taxSlabField) {
      taxSlabField.style.display = applyGST.checked ? "block" : "none";
    }
  }

  // Run once on page load
  document.addEventListener("DOMContentLoaded", toggleTaxSlab);

  // Run when checkbox changes
  document.addEventListener("DOMContentLoaded", function(){
    const applyGST = document.getElementById("id_apply_gst");
    if(applyGST){
      applyGST.addEventListener("change", toggleTaxSlab);
    }
  });
</script>


{% endblock %}